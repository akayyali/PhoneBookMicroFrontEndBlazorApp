@using static Microsoft.AspNetCore.Components.Web.RenderMode
@page "/contacts/edit/{contactId:guid}"
@rendermode InteractiveServer


@using MediatR
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using PhoneBook.Kernel
@using PhoneBook.Kernel.Data.Specification
@using global::Contacts.Application.Commands
@using global::Contacts.Application.Queries
@using global::Contacts.Contracts.DTOs
@using global::Contacts.Domain
@using global::Contacts.Domain.Specifications
@using global::Contacts.UI.JSInterop
@using global::Contacts.UI.Models
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject ExampleJsInterop jsInterop

<PageTitle>Create Contact</PageTitle>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            @* Header Section *@
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-0">Create Contact</h2>
                    <p class="text-muted">Add a new person to your contact list.</p>
                </div>
                <button class="btn btn-outline-secondary shadow-sm" @onclick="NavigateBack">
                    <i class="bi bi-arrow-left me-1"></i> Back to List
                </button>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-4 p-md-5">
                    <EditForm Model="model" OnValidSubmit="HandleValidSubmit">

                        <DataAnnotationsValidator />
                        @* Section 1: Basic Information *@
                        <div class="mb-4">
                            <h5 class="text-primary mb-3 border-bottom pb-2">Personal Information</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">First Name <span class="text-danger">*</span></label>
                                    <InputText class="form-control" @bind-Value="model.FirstName" placeholder="John" />
                                    <ValidationMessage For="@(() => model.FirstName)" class="text-danger small" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Last Name <span class="text-danger">*</span></label>
                                    <InputText class="form-control" @bind-Value="model.LastName" placeholder="Doe" />
                                    <ValidationMessage For="@(() => model.LastName)" class="text-danger small" />
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-semibold">Email Address</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                        <InputText class="form-control" @bind-Value="model.Email" placeholder="email@example.com" />
                                    </div>
                                    <ValidationMessage For="@(() => model.Email)" class="text-danger small" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">Code</label>
                                    <InputText class="form-control" @bind-Value="model.CountryCode" placeholder="+1" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">Phone <span class="text-danger">*</span></label>
                                    <InputText class="form-control" @bind-Value="model.PhoneNumber" />
                                    <ValidationMessage For="@(() => model.PhoneNumber)" class="text-danger small" />
                                </div>
                            </div>
                        </div>

                        @* Section 2: Professional Details *@
                        <div class="mb-4">
                            <h5 class="text-primary mb-3 border-bottom pb-2">Professional</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Company</label>
                                    <InputText class="form-control" @bind-Value="model.Company" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Job Title</label>
                                    <InputText class="form-control" @bind-Value="model.JobTitle" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Contact Group</label>
                                    <InputSelect class="form-select" @bind-Value="model.ContactGroupIdString" @ValueChanged="(string value) => OnValueChanged(value )">
                                        <option value="">-- No Group assigned --</option>
                                        @if (contactGroups != null)
                                        {
                                            @foreach (var g in contactGroups)
                                            {
                                                <option value="@g.Id">@g.Name</option>
                                            }
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                        </div>

                        @* Section 3: Address *@
                        <div class="mb-4">
                            <h5 class="text-primary mb-3 border-bottom pb-2">Address (Optional)</h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Street Address</label>
                                    <InputText class="form-control" @bind-Value="model.Street" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">City</label>
                                    <InputText class="form-control" @bind-Value="model.City" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">State / Province</label>
                                    <InputText class="form-control" @bind-Value="model.State" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Postal Code</label>
                                    <InputText class="form-control" @bind-Value="model.PostalCode" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Country</label>
                                    <InputText class="form-control" @bind-Value="model.Country" />
                                </div>
                            </div>
                        </div>

                        @* Section 4: Extra *@
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Internal Notes</label>
                            <InputTextArea class="form-control" @bind-Value="model.Notes" Rows="3" placeholder="Add any relevant details about this contact..." />
                        </div>

                        @* Form Actions *@
                        <div class="d-flex justify-content-end gap-2 border-top pt-4">
                            <button class="btn btn-light px-4" type="button" @onclick="NavigateBack">Cancel</button>
                            <button class="btn btn-primary px-5 shadow-sm" disabled="@isSubmitting">
                                <i class="bi bi-person-plus-fill me-2"></i>
                                <span>Update Contact</span>
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Logic remains identical to your original code
    [Parameter]
    public Guid contactId { get; set; }

    private EditContactModel model = new();
    private bool isSubmitting = false;
    private List<ContactGroupDto> contactGroups = new();

    protected override async Task OnInitializedAsync() => await LoadData();
    private bool isLoading = true;
    private async Task LoadData()
    {
        try
        {
            ContactDto? contact;


            //we need the specification pattern to query specific contact
            isLoading = true;
            var query = new GetContactsQuery(new GetContactsSpecification(contactId) { TrackingOptions = enumTrackingOptions.DoNotTrack });
            contact = (await Mediator.Send(query)).ToList().FirstOrDefault();
            if (contact != null)
            {
                model.FirstName = contact.FirstName;
                model.LastName = contact.LastName;
                model.PhoneNumber = contact.PhoneNumber;
                model.CountryCode = contact.CountryCode;
                model.Email = contact.Email;
                model.Street = contact.Address?.Street ?? "";
                model.City = contact.Address?.Suburb ?? "";
                model.State = contact.Address?.State ?? "";
                model.PostalCode = contact.Address?.PostCode ?? "";
                model.Country = contact.Address?.Country ?? "";
                model.Company = contact.Company;
                model.JobTitle = contact.JobTitle;
                model.Notes = contact.Notes;
                model.ContactGroupIdString = contact.ContactGroupId?.ToString() ?? "";

            }

            isLoading = false;


            var groups = await Mediator.Send(new GetAllContactGroupsQuery());
            contactGroups = groups?.ToList() ?? new List<ContactGroupDto>();
        }
        catch { contactGroups = new List<ContactGroupDto>(); }
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        try
        {
            await jsInterop.AlertUser("Update function is not implemented yet.");
            Navigation.NavigateTo("/contacts");
        }
        catch (Exception ex)
        {
            await jsInterop.AlertUser($"Error: {ex.Message}");
        }
        finally { isSubmitting = false; }
    }

    private void NavigateBack() => Navigation.NavigateTo("/contacts");
}