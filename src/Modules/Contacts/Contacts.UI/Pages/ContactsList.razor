@using static Microsoft.AspNetCore.Components.Web.RenderMode

@page "/contacts"
@rendermode InteractiveServer

@using MediatR
@using Microsoft.JSInterop
@using PhoneBook.Kernel
@using PhoneBook.Kernel.Data.Specification
@using global::Contacts.Application.Commands
@using global::Contacts.Application.Queries
@using global::Contacts.Contracts.DTOs
@using global::Contacts.Domain
@using global::Contacts.Domain.Specifications
@using global::Contacts.UI.JSInterop
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ContactsJsInterop jsInterop


<PageTitle>Contacts List</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Contacts</h2>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="NavigateToCreate">
                <i class="bi bi-plus-circle"></i> Add Contact
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (contacts != null && contacts.Any())
    {
        <div class="row">
            @foreach (var contactDto in contacts)
            {
                <Contacts.UI.Components.ContactCard contact="contactDto" OnContactDelete="OnContactDeleted" />
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">
            No contacts found. Click "Add Contact" to create your first contact.
        </div>
    }
</div>

@code {
    private List<ContactDto>? contacts;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadContacts();
    }

    private async Task LoadContacts()
    {
        isLoading = true;
        var query = new GetContactsQuery(new GetContactsSpecification() { TrackingOptions = enumTrackingOptions.DoNotTrack });
        contacts = (await Mediator.Send(query)).ToList();
        isLoading = false;
    }

    private async Task OnContactDeleted(Guid contactId)
    {
        contacts?.RemoveAll(c => c.Id == contactId);
    }

    private void NavigateToCreate() => Navigation.NavigateTo("/contacts/create");

}